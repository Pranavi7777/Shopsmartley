{% extends "base.html" %}
{% block title %}Add Product{% endblock %}
{% block content %}
<h2>Add Product</h2>
<form id="productForm">
  <div class="form-group">
    <label>Product Name</label>
    <input type="text" id="product_name" class="form-control" required>
  </div>
  <div class="form-group">
    <label>Category</label>
    <input type="text" id="category" class="form-control" required>
  </div>
  <div id="vendorsSection">
    <label>Vendors</label>
    <div class="vendor-row mb-2">
      <input type="text" placeholder="Vendor Name" class="vendor_name form-control d-inline w-25" required>
      <input type="url" placeholder="Vendor URL" class="vendor_url form-control d-inline w-50" required>
      <input type="number" placeholder="Price" class="vendor_price form-control d-inline w-20" required>
      <button type="button" class="btn btn-danger btn-sm remove-vendor">X</button>
    </div>
  </div>
  <button type="button" class="btn btn-secondary mb-2" id="addVendorBtn">Add Another Vendor</button>
  <button type="submit" class="btn btn-primary">Add Product</button>
</form>
<div id="productMessage" class="mt-2"></div>
{% endblock %}
{% block extra_js %}
<script>
function vendorRowHtml() {
  return `<div class="vendor-row mb-2">
    <input type="text" placeholder="Vendor Name" class="vendor_name form-control d-inline w-25" required>
    <input type="url" placeholder="Vendor URL" class="vendor_url form-control d-inline w-50" required>
    <input type="number" placeholder="Price" class="vendor_price form-control d-inline w-20" required>
    <button type="button" class="btn btn-danger btn-sm remove-vendor">X</button>
  </div>`;
}
document.getElementById('addVendorBtn').onclick = function() {
  document.getElementById('vendorsSection').insertAdjacentHTML('beforeend', vendorRowHtml());
};
document.getElementById('vendorsSection').addEventListener('click', function(e){
  if(e.target.classList.contains('remove-vendor')) {
    e.target.parentElement.remove();
  }
});
document.getElementById('productForm').addEventListener('submit', function(e){
  e.preventDefault();
  const vendors = [];
  document.querySelectorAll('.vendor-row').forEach(row => {
    vendors.push({
      vendor_name: row.querySelector('.vendor_name').value,
      vendor_website: row.querySelector('.vendor_url').value,
      price: row.querySelector('.vendor_price').value
    });
  });
  fetch('/products', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      product_name: document.getElementById('product_name').value,
      category: document.getElementById('category').value,
      vendors: vendors
    })
  })
  .then(r => r.json())
  .then(res => {
    document.getElementById('productMessage').innerHTML = '<div class="alert alert-success">'+res.message+'</div>';
    document.getElementById('productForm').reset();
    document.querySelectorAll('.vendor-row').forEach((row,i) => { if(i>0) row.remove(); });
  })
  .catch(()=> document.getElementById('productMessage').innerHTML = '<div class="alert alert-danger">Failed to add product</div>');
});
</script>
{% endblock %}